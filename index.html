<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeMaster Pro | Learn to Earn</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel-dark: #1e293b;
            --accent: #3b82f6; /* Blue */
            --accent-glow: 0 0 15px rgba(59, 130, 246, 0.5);
            --success: #10b981;
            --error: #ef4444;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --font-stack: 'Inter', system-ui, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-stack);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* --- AUTH SCREEN (LOGIN) --- */
        #authScreen {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--bg-dark);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
        }

        .auth-card {
            background: var(--panel-dark);
            padding: 40px;
            border-radius: 16px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 1px solid #334155;
            text-align: center;
        }

        .auth-card h1 { margin-bottom: 10px; color: var(--accent); }
        .auth-card input {
            width: 100%; padding: 12px; margin: 10px 0;
            background: #0f172a; border: 1px solid #334155;
            color: white; border-radius: 6px; outline: none;
        }
        .auth-card input:focus { border-color: var(--accent); }
        
        .btn-primary {
            background: var(--accent); color: white; border: none;
            padding: 12px 24px; border-radius: 6px; cursor: pointer;
            font-weight: bold; width: 100%; margin-top: 10px;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- APP LAYOUT --- */
        .sidebar {
            width: 260px;
            background: var(--panel-dark);
            border-right: 1px solid #334155;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .logo { font-size: 24px; font-weight: bold; color: white; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .logo span { color: var(--accent); }

        .nav-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex; align-items: center; gap: 10px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: var(--accent); color: white; }

        .user-profile {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #334155;
        }
        .user-level { font-size: 12px; color: var(--accent); font-weight: bold; margin-bottom: 5px; }
        .xp-bar-bg { height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .xp-bar-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: none; /* Hidden until view selected */
        }
        .main-content.active-view { display: block; }

        /* --- DASHBOARD VIEW --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--panel-dark);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #334155;
        }
        .stat-val { font-size: 32px; font-weight: bold; color: white; margin: 10px 0; }
        .stat-label { color: var(--text-muted); font-size: 14px; }

        .history-table {
            width: 100%; border-collapse: collapse;
            background: var(--panel-dark); border-radius: 12px; overflow: hidden;
        }
        .history-table th, .history-table td {
            padding: 15px; text-align: left; border-bottom: 1px solid #334155; color: var(--text-muted);
        }
        .history-table th { background: #0f172a; color: white; }

        /* --- GAME VIEW (Typing Engine) --- */
        .game-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .mode-select { padding: 10px; background: var(--panel-dark); color: white; border: 1px solid #334155; border-radius: 6px; }

        .typing-box {
            background: #151f32;
            padding: 30px;
            border-radius: 12px;
            font-family: var(--font-mono);
            font-size: 24px;
            line-height: 1.6;
            min-height: 100px;
            margin-bottom: 30px;
            border: 1px solid #334155;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            position: relative;
        }
        
        /* Characters */
        .char { opacity: 0.5; transition: color 0.1s; }
        .char.correct { color: var(--success); opacity: 1; }
        .char.wrong { color: var(--error); text-decoration: underline; }
        .char.active { 
            background: var(--accent); color: #000; opacity: 1; 
            box-shadow: 0 0 10px var(--accent); border-radius: 2px;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.7; } }

        /* Virtual Keyboard */
        .keyboard { display: flex; flex-direction: column; gap: 5px; user-select: none; }
        .row { display: flex; justify-content: center; gap: 5px; }
        .key {
            width: 40px; height: 40px;
            background: var(--panel-dark);
            border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; color: var(--text-muted);
            border-bottom: 2px solid #000;
            transition: all 0.05s;
        }
        .key.wide { width: 70px; } .key.space { width: 250px; }
        .key.active-key { transform: translateY(2px); border-bottom: 0; background: var(--accent); color: white; }
        .key.hit-wrong { background: var(--error) !important; }

        /* --- TOAST NOTIFICATIONS --- */
        #toast {
            position: fixed; bottom: 20px; right: 20px;
            background: var(--success); color: white;
            padding: 15px 25px; border-radius: 8px;
            display: none; animation: slideIn 0.3s ease-out;
            z-index: 2000;
        }
        @keyframes slideIn { from{transform: translateX(100%);} to{transform: translateX(0);} }

    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-card">
            <h1>TypeMaster Pro</h1>
            <p style="color:var(--text-muted)">Master the keyboard. Track your progress.</p>
            <input type="text" id="usernameInput" placeholder="Enter Username">
            <button class="btn-primary" onclick="handleLogin()">Start Practicing</button>
            <p style="font-size: 12px; margin-top: 15px; color: #666;">*Uses LocalStorage. Data stays on this browser.</p>
        </div>
    </div>

    <div class="sidebar">
        <div class="logo">‚å®Ô∏è Type<span>Pro</span></div>
        
        <div class="nav-item active" onclick="switchView('dashboard')">üìä Dashboard</div>
        <div class="nav-item" onclick="switchView('game')">üéÆ Practice Arena</div>
        <div class="nav-item" onclick="logout()">üö™ Logout</div>

        <div class="user-profile">
            <div class="user-level" id="levelLabel">Level 1: Novice</div>
            <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:5px;">
                <span>XP</span> <span id="xpText">0 / 500</span>
            </div>
            <div class="xp-bar-bg">
                <div class="xp-bar-fill" id="xpFill"></div>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="main-content active-view">
        <h2 style="margin-top:0;">Your Progress</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Tests Taken</div>
                <div class="stat-val" id="totalTests">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Best WPM</div>
                <div class="stat-val" style="color:var(--success)" id="bestWpm">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg Accuracy</div>
                <div class="stat-val" style="color:var(--accent)" id="avgAcc">0%</div>
            </div>
        </div>

        <h3>Recent History</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Mode</th>
                    <th>WPM</th>
                    <th>Accuracy</th>
                    <th>XP Earned</th>
                </tr>
            </thead>
            <tbody id="historyBody">
                </tbody>
        </table>
    </div>

    <div id="view-game" class="main-content">
        <div class="game-header">
            <div>
                <h2 style="margin:0;">Practice Arena</h2>
                <div style="font-size:14px; color:var(--text-muted);">Mode: <span id="currentModeDisplay">Home Row</span></div>
            </div>
            <div style="display:flex; gap:10px;">
                <select id="levelSelect" class="mode-select" onchange="initGame()">
                    <option value="home">Home Row (Easy)</option>
                    <option value="top">Top Row (Medium)</option>
                    <option value="bottom">Bottom Row (Medium)</option>
                    <option value="sentences">Sentences (Hard)</option>
                    <option value="code">Code (Expert)</option>
                </select>
                <button class="btn-primary" style="margin:0; padding:10px;" onclick="initGame()">Reset</button>
            </div>
        </div>

        <div class="typing-box" id="displayArea">Press any key to start...</div>

        <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-size:18px; font-weight:bold;">
            <div>Time: <span id="timer">0</span>s</div>
            <div>WPM: <span id="liveWpm" style="color:var(--success)">0</span></div>
            <div>Errors: <span id="liveErrors" style="color:var(--error)">0</span></div>
        </div>

        <div class="keyboard" id="keyboard">
            <div class="row">
                <div class="key" data-key="q">Q</div><div class="key" data-key="w">W</div><div class="key" data-key="e">E</div>
                <div class="key" data-key="r">R</div><div class="key" data-key="t">T</div><div class="key" data-key="y">Y</div>
                <div class="key" data-key="u">U</div><div class="key" data-key="i">I</div><div class="key" data-key="o">O</div>
                <div class="key" data-key="p">P</div>
            </div>
            <div class="row">
                <div class="key" data-key="a">A</div><div class="key" data-key="s">S</div><div class="key" data-key="d">D</div>
                <div class="key" data-key="f">F</div><div class="key" data-key="g">G</div><div class="key" data-key="h">H</div>
                <div class="key" data-key="j">J</div><div class="key" data-key="k">K</div><div class="key" data-key="l">L</div>
                <div class="key" data-key=";">;</div>
            </div>
            <div class="row">
                <div class="key" data-key="z">Z</div><div class="key" data-key="x">X</div><div class="key" data-key="c">C</div>
                <div class="key" data-key="v">V</div><div class="key" data-key="b">B</div><div class="key" data-key="n">N</div>
                <div class="key" data-key="m">M</div><div class="key" data-key=",">,</div><div class="key" data-key=".">.</div>
            </div>
            <div class="row"><div class="key space" data-key=" ">SPACE</div></div>
        </div>
    </div>

    <div id="toast"></div>

    <script>
        // --- 1. "BACKEND" (Simulated via LocalStorage) ---
        const DB = {
            getUser: () => JSON.parse(localStorage.getItem('typepro_user')),
            saveUser: (user) => localStorage.setItem('typepro_user', JSON.stringify(user)),
            initUser: (username) => {
                return {
                    username: username,
                    xp: 0,
                    level: 1,
                    bestWpm: 0,
                    history: [] // {date, wpm, acc, mode, xp}
                };
            }
        };

        const LEVEL_THRESHOLDS = [0, 500, 1500, 3000, 6000, 10000];
        const TITLES = ["Novice", "Script Kiddie", "Code Monkey", "Hacker", "Cyber Lord", "The Architect"];

        let currentUser = null;

        // --- 2. AUTH LOGIC ---
        function handleLogin() {
            const input = document.getElementById('usernameInput');
            const username = input.value.trim();
            if (!username) return alert("Please enter a username");

            let stored = DB.getUser();
            if (stored && stored.username === username) {
                currentUser = stored;
            } else {
                currentUser = DB.initUser(username);
                DB.saveUser(currentUser);
            }

            document.getElementById('authScreen').style.display = 'none';
            updateUIProfile();
            loadHistory();
            switchView('dashboard');
        }

        function logout() {
            location.reload();
        }

        function addXP(amount) {
            currentUser.xp += amount;
            
            // Level Up Logic
            const nextLevelXP = LEVEL_THRESHOLDS[currentUser.level];
            if (currentUser.xp >= nextLevelXP && currentUser.level < TITLES.length) {
                currentUser.level++;
                showToast(`üéâ LEVEL UP! You are now a ${TITLES[currentUser.level - 1]}`);
            }
            
            DB.saveUser(currentUser);
            updateUIProfile();
        }

        function saveRun(wpm, acc, mode) {
            const xpEarned = Math.floor((wpm * acc) / 10); // Simple XP Formula
            addXP(xpEarned);

            const runData = {
                date: new Date().toLocaleDateString(),
                wpm: wpm,
                acc: acc,
                mode: mode,
                xp: xpEarned
            };

            currentUser.history.unshift(runData); // Add to top
            if (currentUser.history.length > 20) currentUser.history.pop(); // Keep last 20
            
            if (wpm > currentUser.bestWpm) {
                currentUser.bestWpm = wpm;
                showToast(`üöÄ NEW HIGH SCORE: ${wpm} WPM`);
            }

            DB.saveUser(currentUser);
            loadHistory(); // Refresh Dashboard
        }

        // --- 3. UI UPDATES ---
        function updateUIProfile() {
            if (!currentUser) return;
            
            const title = TITLES[currentUser.level - 1] || "Master";
            const nextXP = LEVEL_THRESHOLDS[currentUser.level] || 99999;
            const prevXP = LEVEL_THRESHOLDS[currentUser.level - 1] || 0;
            
            // Calculate Bar Percentage
            const progress = currentUser.xp - prevXP;
            const totalNeeded = nextXP - prevXP;
            const pct = Math.min(100, Math.max(0, (progress / totalNeeded) * 100));

            document.getElementById('levelLabel').innerText = `Lvl ${currentUser.level}: ${title}`;
            document.getElementById('xpText').innerText = `${currentUser.xp} / ${nextXP} XP`;
            document.getElementById('xpFill').style.width = `${pct}%`;

            // Stats
            document.getElementById('totalTests').innerText = currentUser.history.length;
            document.getElementById('bestWpm').innerText = currentUser.bestWpm;
            
            // Calc Avg Acc
            if(currentUser.history.length > 0) {
                const totalAcc = currentUser.history.reduce((sum, h) => sum + h.acc, 0);
                document.getElementById('avgAcc').innerText = Math.round(totalAcc / currentUser.history.length) + "%";
            }
        }

        function loadHistory() {
            const tbody = document.getElementById('historyBody');
            tbody.innerHTML = '';
            
            currentUser.history.forEach(run => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${run.date}</td>
                    <td>${run.mode}</td>
                    <td style="color:var(--success); font-weight:bold;">${run.wpm}</td>
                    <td>${run.acc}%</td>
                    <td>+${run.xp} XP</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function switchView(viewId) {
            document.querySelectorAll('.main-content').forEach(el => el.classList.remove('active-view'));
            document.getElementById(`view-${viewId}`).classList.add('active-view');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Highlight nav
            if(viewId === 'dashboard') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(viewId === 'game') document.querySelectorAll('.nav-item')[1].classList.add('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- 4. GAME ENGINE (Optimized) ---
        const exercises = {
            home: ["asdf jkl;", "dad has a salad", "flask falls", "ask a lad"],
            top: ["qwerty uiop", "quiet poet", "write report", "tree root"],
            bottom: ["zxcv bnm", "zen cab", "van man", "bad box"],
            sentences: ["The quick brown fox jumps.", "Practice makes perfect.", "To be or not to be."],
            code: ["const x = 10;", "return true;", "<div></div>", "import React;"]
        };

        // Game State
        let text = "";
        let idx = 0;
        let errors = 0;
        let timer = null;
        let startT = null;
        let isRunning = false;
        
        // Audio
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(type) {
             if(audioCtx.state === 'suspended') audioCtx.resume();
             const osc = audioCtx.createOscillator();
             const gain = audioCtx.createGain();
             osc.connect(gain); gain.connect(audioCtx.destination);
             const now = audioCtx.currentTime;
             
             if(type==='good') {
                 osc.frequency.setValueAtTime(600, now);
                 osc.frequency.exponentialRampToValueAtTime(800, now+0.1);
                 gain.gain.setValueAtTime(0.05, now);
                 gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                 osc.start(now); osc.stop(now+0.1);
             } else {
                 osc.type = 'sawtooth';
                 osc.frequency.setValueAtTime(150, now);
                 gain.gain.setValueAtTime(0.1, now);
                 gain.gain.exponentialRampToValueAtTime(0.01, now+0.1);
                 osc.start(now); osc.stop(now+0.15);
             }
        }

        function initGame() {
            clearInterval(timer);
            isRunning = false;
            idx = 0;
            errors = 0;
            startT = null;
            document.getElementById('timer').innerText = "0";
            document.getElementById('liveWpm').innerText = "0";
            document.getElementById('liveErrors').innerText = "0";

            const mode = document.getElementById('levelSelect').value;
            const list = exercises[mode];
            text = list[Math.floor(Math.random() * list.length)];
            document.getElementById('currentModeDisplay').innerText = mode.toUpperCase();
            
            renderText();
        }

        function renderText() {
            const div = document.getElementById('displayArea');
            div.innerHTML = '';
            text.split('').forEach((char, i) => {
                const s = document.createElement('span');
                s.innerText = char;
                s.className = 'char';
                if(i < idx) s.classList.add('correct');
                if(i === idx) s.classList.add('active');
                div.appendChild(s);
            });
        }

        window.addEventListener('keydown', (e) => {
            if(document.getElementById('view-game').style.display === 'none' && !document.getElementById('view-game').classList.contains('active-view')) return;
            if(e.key === 'Shift' || e.key === 'Control') return;
            
            // Keyboard visual
            const k = document.querySelector(`.key[data-key="${e.key.toLowerCase()}"]`) || document.querySelector(`.key[data-key="${e.key}"]`);
            if(k) { k.classList.add('active-key'); setTimeout(()=>k.classList.remove('active-key'), 100); }

            if(!isRunning) {
                isRunning = true;
                startT = Date.now();
                timer = setInterval(() => {
                    const sec = Math.floor((Date.now() - startT)/1000);
                    document.getElementById('timer').innerText = sec;
                    const wpm = Math.round((idx/5)/(sec/60)) || 0;
                    document.getElementById('liveWpm').innerText = wpm;
                }, 1000);
            }

            const target = text[idx];
            if(e.key === target) {
                playTone('good');
                idx++;
                if(idx >= text.length) finishGame();
                else renderText();
            } else {
                playTone('bad');
                errors++;
                document.getElementById('liveErrors').innerText = errors;
                // Visual Error
                document.querySelector('.char.active').classList.add('wrong');
            }
        });

        function finishGame() {
            clearInterval(timer);
            const sec = Math.max(1, Math.floor((Date.now() - startT)/1000));
            const wpm = Math.round((text.length/5)/(sec/60));
            const acc = Math.max(0, Math.round(((text.length - errors)/text.length)*100));
            
            const mode = document.getElementById('levelSelect').value;
            
            saveRun(wpm, acc, mode);
            showToast(`Completed! ${wpm} WPM (+XP)`);
            setTimeout(initGame, 1500);
        }

        // Check Login Status on Load
        if(DB.getUser()) {
             // Optional: Auto-login
             // currentUser = DB.getUser();
             // document.getElementById('authScreen').style.display = 'none';
             // switchView('dashboard');
             // updateUIProfile();
        }

    </script>
</body>
</html>
