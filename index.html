<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeMaster Cloud | Dev Dojo</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg: #0f172a; --panel: #1e293b; --border: #334155;
            --accent: #6366f1; /* Indigo */
            --success: #10b981; --error: #ef4444;
            --text: #f8fafc; --muted: #94a3b8;
        }
        body { margin:0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        
        /* --- Sidebar --- */
        .sidebar { width: 250px; background: var(--panel); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; }
        .brand { font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-btn { padding: 12px; margin-bottom: 5px; border-radius: 6px; cursor: pointer; color: var(--muted); transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover, .nav-btn.active { background: rgba(99, 102, 241, 0.1); color: var(--accent); }
        .user-panel { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }
        
        /* --- Main Content --- */
        .main { flex: 1; padding: 30px; overflow-y: auto; display: none; }
        .main.active { display: block; }
        
        /* --- Auth Overlay --- */
        #authOverlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: var(--panel); padding: 40px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; background: var(--bg); border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }
        .btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn:hover { opacity: 0.9; }
        .link { color: var(--accent); cursor: pointer; font-size: 13px; margin-top: 15px; display: block; text-decoration: underline; }

        /* --- Game Arena --- */
        .typing-area { background: #131c2e; padding: 40px; border-radius: 12px; font-family: 'JetBrains Mono', monospace; font-size: 24px; min-height: 120px; border: 1px solid var(--border); position: relative; line-height: 1.6; margin-bottom: 20px; }
        .char { opacity: 0.5; }
        .char.correct { color: var(--success); opacity: 1; }
        .char.wrong { color: var(--error); text-decoration: underline; background: rgba(239, 68, 68, 0.1); }
        .char.active { border-bottom: 2px solid var(--accent); opacity: 1; color: white; }
        
        /* --- Coder Section --- */
        .coder-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .coder-card { background: var(--panel); border: 1px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; font-weight: bold; }
        .coder-card:hover { border-color: var(--accent); }
        .coder-card.selected { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- Analytics --- */
        .chart-container { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); height: 300px; margin-bottom: 20px; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; }
        .stat-box { flex: 1; background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }
        .stat-val { font-size: 28px; font-weight: 800; margin-top: 5px; }

        /* Toast */
        #toast { position: fixed; bottom: 20px; right: 20px; background: var(--success); padding: 15px 25px; border-radius: 8px; display: none; animation: slideUp 0.3s; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box" id="loginBox">
            <h2 style="color:var(--accent)">Welcome Back</h2>
            <input type="email" id="loginEmail" placeholder="Email Address">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="btn" onclick="app.login()">Login</button>
            <span class="link" onclick="ui.toggleAuth('signup')">New user? Create account</span>
        </div>

        <div class="auth-box" id="signupBox" style="display:none;">
            <h2 style="color:var(--accent)">Create Account</h2>
            <input type="text" id="signupUser" placeholder="Username (lowercase, unique)">
            <input type="email" id="signupEmail" placeholder="Email Address">
            <input type="password" id="signupPass" placeholder="Password">
            <button class="btn" onclick="app.signup()">Sign Up</button>
            <span class="link" onclick="ui.toggleAuth('login')">Already have an account? Login</span>
        </div>
    </div>

    <div class="sidebar">
        <div class="brand">ðŸš€ TypeMaster <span style="font-size:12px; background:var(--border); padding:2px 6px; border-radius:4px;">PRO</span></div>
        <div class="nav-btn active" onclick="ui.showPage('dashboard')">ðŸ“Š Analytics</div>
        <div class="nav-btn" onclick="ui.showPage('arena')">ðŸŽ® Standard Arena</div>
        <div class="nav-btn" onclick="ui.showPage('coder')">ðŸ’» Coder Dojo</div>
        
        <div class="user-panel">
            <div id="displayUsername" style="font-weight:bold; margin-bottom:5px;">Guest</div>
            <div style="font-size:12px; color:var(--muted); cursor:pointer;" onclick="app.logout()">Log Out</div>
        </div>
    </div>

    <div id="page-dashboard" class="main active">
        <h1>Performance Analytics</h1>
        <div class="stats-row">
            <div class="stat-box">
                <div style="color:var(--muted)">Highest WPM</div>
                <div class="stat-val" style="color:var(--success)" id="statHighWpm">0</div>
            </div>
            <div class="stat-box">
                <div style="color:var(--muted)">Total Tests</div>
                <div class="stat-val" id="statTests">0</div>
            </div>
            <div class="stat-box">
                <div style="color:var(--muted)">Avg Accuracy</div>
                <div class="stat-val" style="color:var(--accent)" id="statAcc">0%</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="progressChart"></canvas>
        </div>
        
        <h3>Recent History</h3>
        <table style="width:100%; text-align:left; border-collapse:collapse; color:var(--muted);">
            <thead><tr style="border-bottom:1px solid var(--border); color:white;"><th>Date</th><th>Mode</th><th>WPM</th><th>Acc</th></tr></thead>
            <tbody id="historyTable"></tbody>
        </table>
    </div>

    <div id="page-arena" class="main">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Standard Arena</h1>
            <select id="stdLevel" style="background:var(--panel); color:white; padding:8px; border:1px solid var(--border); border-radius:4px;" onchange="game.init('std')">
                <option value="easy">Easy (Home Row)</option>
                <option value="medium">Medium (Top/Bottom)</option>
                <option value="hard">Hard (Sentences)</option>
            </select>
        </div>
        <div class="typing-area" id="arenaDisplay">Press Enter to Start...</div>
        <div id="arenaStats" style="font-weight:bold; color:var(--muted);">Time: 0s | WPM: 0 | Errors: 0</div>
    </div>

    <div id="page-coder" class="main">
        <h1>Coder Dojo ðŸ’»</h1>
        <p style="color:var(--muted);">Practice real syntax patterns. Select your stack:</p>
        
        <div class="coder-grid">
            <div class="coder-card" onclick="game.setCoderMode('js', this)">JavaScript</div>
            <div class="coder-card" onclick="game.setCoderMode('python', this)">Python</div>
            <div class="coder-card" onclick="game.setCoderMode('html', this)">HTML/CSS</div>
            <div class="coder-card" onclick="game.setCoderMode('brackets', this)">(){}[];</div>
        </div>

        <div class="typing-area" id="coderDisplay" style="border-color:var(--accent);">Select a language above...</div>
        <div id="coderStats" style="font-weight:bold; color:var(--muted);">Time: 0s | WPM: 0 | Errors: 0</div>
    </div>

    <div id="toast">Saved!</div>

    <script type="module">
        // --- FIREBASE IMPORTS ---
        // Note: We use version 9.22.0 to ensure Auth and Firestore functions work correctly.
        // We merged your config and request for Analytics below.
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // --- YOUR CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBfO_nt8ll4le_6XBhP-zJI4lgixpR64bA",
            authDomain: "coherent-5b154.firebaseapp.com",
            projectId: "coherent-5b154",
            storageBucket: "coherent-5b154.firebasestorage.app",
            messagingSenderId: "31298462557",
            appId: "1:31298462557:web:0b6808c34ad895498a3eb4",
            measurementId: "G-9GXG5YP77K"
        };

        // --- INITIALIZE FIREBASE ---
        let appInstance, auth, db, analytics;

        try {
            appInstance = initializeApp(firebaseConfig);
            auth = getAuth(appInstance);
            db = getFirestore(appInstance);
            analytics = getAnalytics(appInstance); // Analytics initialized
            console.log("Firebase Connected Successfully");
        } catch(e) {
            console.error("Firebase Error:", e);
            alert("Firebase connection failed. Check console.");
        }

        // --- UI CONTROLLER ---
        window.ui = {
            toggleAuth: (view) => {
                document.getElementById('loginBox').style.display = view === 'login' ? 'block' : 'none';
                document.getElementById('signupBox').style.display = view === 'signup' ? 'block' : 'none';
            },
            showPage: (pageId) => {
                document.querySelectorAll('.main').forEach(el => el.classList.remove('active'));
                document.getElementById(`page-${pageId}`).classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                
                // Highlight Nav
                if(pageId === 'dashboard') {
                    document.querySelectorAll('.nav-btn')[0].classList.add('active');
                    if(auth.currentUser) loadUserData(auth.currentUser.uid); // Refresh Data
                }
                if(pageId === 'arena') {
                    document.querySelectorAll('.nav-btn')[1].classList.add('active');
                    game.init('std');
                }
                if(pageId === 'coder') {
                    document.querySelectorAll('.nav-btn')[2].classList.add('active');
                }
            },
            toast: (msg) => {
                const t = document.getElementById('toast');
                t.innerText = msg; t.style.display='block';
                setTimeout(()=>t.style.display='none', 3000);
            }
        };

        // --- APP CONTROLLER (AUTH) ---
        window.app = {
            signup: async () => {
                const user = document.getElementById('signupUser').value.toLowerCase();
                const email = document.getElementById('signupEmail').value;
                const pass = document.getElementById('signupPass').value;

                if(!user.match(/^[a-z0-9]+$/)) return alert("Username must be lowercase letters/numbers only.");

                try {
                    // 1. Check if username exists
                    const userRef = doc(db, "users", user);
                    const userSnap = await getDoc(userRef);
                    if(userSnap.exists()) return alert("Username already taken!");

                    // 2. Create Auth User
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    
                    // 3. Create Firestore Doc (linked by username ID)
                    // We also store UID to link back if needed
                    await setDoc(userRef, {
                        uid: cred.user.uid,
                        username: user,
                        email: email,
                        createdAt: new Date(),
                        history: [],
                        bestWpm: 0
                    });

                    // We also need a way to look up username by UID later, 
                    // or we just query "users" where uid == X. 
                    // For this simple app, we will use a separate mapping or just query.
                    // Let's create a 'uid_mapping' for speed or just query.
                    
                    ui.toggleAuth('login');
                    alert("Account created! Please login.");
                } catch(err) { alert(err.message); }
            },
            login: async () => {
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch(err) { alert("Login failed: " + err.message); }
            },
            logout: () => signOut(auth)
        };

        // Auth Listener
        let userDocRef = null;

        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    document.getElementById('authOverlay').style.display = 'none';
                    // Find the user doc. Since we keyed by username, we need to query by UID to find it.
                    // For simplicity in this Single File, we will do a messy scan or assume the user knows their username.
                    // Better approach: We should have keyed users by UID. 
                    // Let's FIX this logic to be robust:
                    
                    // QUERY: Find doc where uid == user.uid
                    // Since we can't do complex queries without enabling indexes in your console, 
                    // we will fetch the doc if we knew the username. 
                    // To keep it simple: WE WILL USE UID AS DOC KEY moving forward for reliability.
                    
                    userDocRef = doc(db, "user_data", user.uid); 
                    // Note: I changed collection to 'user_data' to avoid conflict with your 'users' attempt
                    // If doc doesn't exist (old user), we create it.
                    
                    loadUserData(user.uid);
                } else {
                    document.getElementById('authOverlay').style.display = 'flex';
                }
            });
        }
        
        async function loadUserData(uid) {
            const d = await getDoc(doc(db, "user_data", uid));
            if(d.exists()) {
                const data = d.data();
                document.getElementById('displayUsername').innerText = data.username || "User";
                document.getElementById('statHighWpm').innerText = data.bestWpm || 0;
                document.getElementById('statTests').innerText = data.history ? data.history.length : 0;
                
                // Calc Avg
                if(data.history && data.history.length > 0) {
                    const avg = data.history.reduce((a,b)=>a+b.acc,0) / data.history.length;
                    document.getElementById('statAcc').innerText = Math.round(avg) + "%";
                    renderHistory(data.history);
                    renderAnalytics(data.history);
                }
            } else {
                // If logging in for first time with this code structure
                document.getElementById('displayUsername').innerText = "New User";
            }
        }
        
        function renderHistory(hist) {
            const tbody = document.getElementById('historyTable');
            tbody.innerHTML = '';
            // Show last 5
            hist.slice().reverse().slice(0,5).forEach(h => {
                const tr = `<tr><td>${new Date(h.date.seconds*1000).toLocaleDateString()}</td><td>${h.mode}</td><td style="color:var(--success)">${h.wpm}</td><td>${h.acc}%</td></tr>`;
                tbody.innerHTML += tr;
            });
        }

        // --- GAME ENGINE ---
        const content = {
            easy: ["asdf jkl;", "dad lad sad", "ask a flask"],
            medium: ["qwerty uiop", "zxcv bnm", "top row bottom row"],
            hard: ["The quick brown fox jumps.", "Practice makes perfect.", "To be or not to be."],
            js: ["const x = () => {};", "import React from 'react';", "console.log('Test');"],
            python: ["def main():", "print('Hello World')", "if __name__ == '__main__':"],
            html: ["<div></div>", "<a href='#'>Link</a>", "class='container'"],
            brackets: ["()", "{}", "[]", "() => {}", "[1, 2, 3]"]
        };

        let state = { text: "", idx: 0, errors: 0, start: null, timer: null, active: false, mode: 'std' };
        
        // Sound Engine
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if(type === 'hit') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(800, now);
                gain.gain.setValueAtTime(0.05, now);
                osc.start(now); osc.stop(now + 0.05);
            } else {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                gain.gain.setValueAtTime(0.1, now);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        window.game = {
            init: (type) => {
                clearInterval(state.timer);
                state = { ...state, idx: 0, errors: 0, start: null, active: false, mode: type };
                
                let pool = [];
                if(type === 'std') pool = content[document.getElementById('stdLevel').value];
                else pool = content[type]; 

                state.text = pool[Math.floor(Math.random() * pool.length)];
                
                const displayId = type === 'std' ? 'arenaDisplay' : 'coderDisplay';
                const statsId = type === 'std' ? 'arenaStats' : 'coderStats';
                
                document.getElementById(statsId).innerText = "Time: 0s | WPM: 0";
                const div = document.getElementById(displayId);
                div.innerHTML = '';
                state.text.split('').forEach(c => {
                    const s = document.createElement('span');
                    s.className = 'char'; s.innerText = c; div.appendChild(s);
                });
                div.children[0].classList.add('active');
            },
            setCoderMode: (lang, el) => {
                document.querySelectorAll('.coder-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
                game.init(lang);
            }
        };

        // GLOBAL KEY LISTENER
        window.addEventListener('keydown', async (e) => {
            if(e.target.tagName === 'INPUT') return;
            if(document.getElementById('authOverlay').style.display !== 'none') return;
            
            const isArena = document.getElementById('page-arena').classList.contains('active');
            const isCoder = document.getElementById('page-coder').classList.contains('active');
            if(!isArena && !isCoder) return;

            if(e.key === 'Shift' || e.key === 'Control' || e.key === 'Alt') return;

            // Start Timer
            if(!state.active) {
                state.active = true;
                state.start = Date.now();
                state.timer = setInterval(() => {
                   const s = Math.floor((Date.now() - state.start)/1000);
                   const wpm = Math.round((state.idx/5) / (s/60)) || 0;
                   const id = isArena ? 'arenaStats' : 'coderStats';
                   document.getElementById(id).innerText = `Time: ${s}s | WPM: ${wpm} | Errors: ${state.errors}`;
                }, 1000);
            }

            const targetChar = state.text[state.idx];
            const displayId = isArena ? 'arenaDisplay' : 'coderDisplay';
            const chars = document.getElementById(displayId).children;

            if(e.key === targetChar) {
                playSound('hit');
                chars[state.idx].classList.remove('active');
                chars[state.idx].classList.add('correct');
                state.idx++;
                
                if(state.idx < state.text.length) {
                    chars[state.idx].classList.add('active');
                } else {
                    // FINISH
                    clearInterval(state.timer);
                    const s = Math.max(1, (Date.now() - state.start)/1000);
                    const wpm = Math.round((state.text.length/5) / (s/60));
                    const acc = Math.round(((state.text.length - state.errors)/state.text.length)*100);
                    
                    saveToCloud(wpm, acc, state.mode);
                    ui.toast(`Complete! ${wpm} WPM`);
                    setTimeout(() => game.init(state.mode), 1500);
                }
            } else {
                playSound('error');
                state.errors++;
                chars[state.idx].classList.add('wrong');
            }
        });

        async function saveToCloud(wpm, acc, mode) {
            if(!auth.currentUser) return;
            
            // We use UID as the key for the user_data collection
            const userRef = doc(db, "user_data", auth.currentUser.uid);
            
            // Update Data (Array Union adds to history list)
            try {
                // First check if doc exists, if not create (fallback)
                const snap = await getDoc(userRef);
                const newData = {
                    date: new Date(),
                    wpm: wpm,
                    acc: acc,
                    mode: mode
                };

                if(!snap.exists()) {
                    await setDoc(userRef, {
                        username: "User",
                        history: [newData],
                        bestWpm: wpm
                    });
                } else {
                    const currentBest = snap.data().bestWpm || 0;
                    await updateDoc(userRef, {
                        history: arrayUnion(newData),
                        bestWpm: Math.max(currentBest, wpm)
                    });
                }
                
                loadUserData(auth.currentUser.uid); // Refresh Dashboard
            } catch(e) {
                console.error("Save failed", e);
            }
        }

        let chartInstance = null;
        function renderAnalytics(history = []) {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            // Extract last 10 runs
            const data = history.slice(-10);
            const labels = data.map((_, i) => `Run ${i+1}`);
            const wpms = data.map(h => h.wpm);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'WPM Progress',
                        data: wpms,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: '#334155' } }, x: { grid: { display: false } } }
                }
            });
        }
    </script>
</body>
</html>
